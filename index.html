<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rust Decay Study | Interactive Analysis</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Import Scientific Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Share+Tech+Mono&display=swap');
        
        body {
            font-family: 'Rajdhani', sans-serif; 
            overflow: hidden; 
            background-color: #000;
            color: #FFF;
            touch-action: none; 
        }
        
        #data-log, #object-name-display-container, .mono-font {
            font-family: 'Share Tech Mono', monospace; 
        }

        /* --- Global Screen Transition --- */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 1.0s ease-in-out; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        .screen.active {
            opacity: 1;
            pointer-events: auto;
            z-index: 20;
        }
        
        /* --- Stage 1: Selection Screen --- */
        #selection-title {
            font-weight: 700; 
            letter-spacing: 0.15em;
            text-transform: uppercase;
            text-align: center;
        }

        .select-btn {
            width: 140px;
            height: 140px;
            background-color: #0a0a0a;
            border: 1px solid #444;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .select-btn::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 10px;
            height: 10px;
            border-bottom: 2px solid #666;
            border-right: 2px solid #666;
            transition: all 0.3s;
        }

        .select-btn:hover, .select-btn:active {
            transform: translateY(-5px);
            border-color: #FFFFFF; 
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.15);
        }
        
        .select-btn:hover::after, .select-btn:active::after {
            border-color: #FFF;
            width: 100%;
            height: 100%;
        }

        .btn-image {
            width: 80%; 
            height: 80%; 
            object-fit: contain; 
        }
        
        /* --- Stage 2: Interactive Screen --- */
        #interactive-screen {
            cursor: grab; 
            overflow: hidden;
        }
        
        #interactive-screen:active {
            cursor: grabbing;
        }
        
        #object-container {
            position: absolute; 
            top: 50%;
            left: 50%;
            width: 80vmin; 
            height: 80vmin;
            display: flex;
            justify-content: center;
            align-items: center;
            user-select: none; 
            transform: translate(-50%, -50%) scale(1); 
            will-change: transform; 
        }
        
        .object-layer {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: contain; 
            transition: opacity 0.1s linear; 
            z-index: 2; 
            pointer-events: none; 
        }

        #layer-video {
            z-index: 3; 
            mix-blend-mode: overlay; 
            pointer-events: none;
            -webkit-mask-size: contain;
            mask-size: contain;
            -webkit-mask-position: center;
            mask-position: center;
            -webkit-mask-repeat: no-repeat;
            mask-repeat: no-repeat;
        }
        
        /* --- Stage 3: Data Screen --- */
        #data-screen {
            background-color: #000;
            color: #FFFFFF; 
            overflow: hidden; 
            padding: 20px;
            height: 100vh; 
        }
        
        .data-panel {
            border: 1px solid #FFFFFF; 
            background-color: rgba(10, 10, 10, 0.8); 
            padding: 20px;
            position: relative;
        }
        
        .data-panel::before { content: ''; position: absolute; top: -1px; left: -1px; width: 20px; height: 20px; border-top: 2px solid #FFF; border-left: 2px solid #FFF; }
        .data-panel::after { content: ''; position: absolute; bottom: -1px; right: -1px; width: 20px; height: 20px; border-bottom: 2px solid #FFF; border-right: 2px solid #FFF; }

        #data-log {
             white-space: pre-wrap; 
             line-height: 1.6;
             direction: ltr; 
             text-align: left;
             font-size: 1.1rem; 
             height: 100%; 
             overflow-y: auto; 
             color: #ddd;
        }
        
        .typing-cursor {
            display: inline-block;
            width: 8px;
            height: 1.1rem;
            background-color: white;
            animation: blink 0.8s infinite;
            margin-left: 4px;
            vertical-align: middle;
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        #stage-selection-list {
            display: flex;
            flex-direction: row; 
            width: 100%;
            height: 80px;
            gap: 8px; 
            overflow-x: auto;
            padding: 2px;
        }
        @media (min-width: 768px) {
            #stage-selection-list {
                flex-direction: column;
                height: 100%;
                width: auto;
            }
        }

        .stage-selector {
            flex: 1; 
            min-width: 70px; 
            height: 100%; 
            border: 1px solid #333; 
            transition: all 0.2s ease;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center; 
            background: #050505;
            position: relative;
        }
        .stage-selector.active {
            border-color: #FFF;
            background-color: #1a1a1a;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
        }
        
        .stage-selector img {
            width: 100%;
            height: 100%;
            object-fit: contain; 
            padding: 4px;
        }

        #data-main-image-container {
            border: 1px solid #333;
            width: 100%;
            height: 100%; 
            margin-bottom: 0; 
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        #data-stage-image {
            object-fit: contain; 
            width: 100%; 
            height: 100%;
            max-height: 100%;
        }

        .data-content-wrapper {
            display: grid;
            grid-template-columns: 1fr; 
            grid-template-rows: 1fr 1fr; 
            gap: 1rem;
            height: 100%;
            overflow: hidden; 
        }

        @media (min-width: 1024px) {
            .data-content-wrapper {
                grid-template-rows: 1.2fr 0.8fr; 
                gap: 1.5rem;
            }
        }
        
        #object-name-display-container {
            direction: ltr;
            text-align: left;
            left: 16px;
            right: auto;
            top: 16px;
            pointer-events: none; 
        }
        
        .instruction-text {
            pointer-events: none; 
            width: 100%;
            text-align: center;
            transition: color 0.3s, opacity 0.3s;
        }
    </style>
</head>
<body class="bg-black text-white">

    <!-- Stage 1: Selection Screen -->
    <div id="selection-screen" class="screen active" dir="ltr">
        <div class="flex flex-col items-center justify-center w-full h-full">
            <h1 id="selection-title" class="text-4xl md:text-7xl mb-8 text-white tracking-widest font-bold text-center">RUST DECAY STUDY</h1>
            <p class="text-lg md:text-xl mb-10 text-gray-400 font-light tracking-wider text-center">SELECT SPECIMEN FOR ANALYSIS</p>

            <div id="object-selection" class="flex flex-wrap justify-center gap-4 md:gap-8 p-4 w-full max-w-5xl">
                <!-- Buttons injected by JS -->
            </div>
            <p class="mt-12 text-xs text-gray-600 tracking-widest uppercase text-center">Scroll/Pinch to Zoom • Drag to Pan</p>
        </div>
    </div>

    <!-- Stage 2: Interactive Screen -->
    <div id="interactive-screen" class="screen" 
         onwheel="handleWheel(event)" 
         onmousedown="handleMouseDown(event)"
         onmousemove="handleMouseMove(event)"
         onmouseup="handleMouseUp(event)"
         onmouseleave="handleMouseUp(event)"
         ontouchstart="handleTouchStart(event)"
         ontouchmove="handleTouchMove(event)"
         ontouchend="handleTouchEnd(event)"
         ondblclick="handleDoubleClick()"
         dir="ltr">
         
        <div id="object-name-display-container" class="absolute top-4 left-4 z-30 text-white tracking-wider">
            <span id="object-name-display" class="font-bold border-b border-white pb-1 text-xl"></span> 
            <div class="text-gray-400 ml-2 text-sm mt-1">ZOOM: <span id="zoom-level">1.0</span>x</div>
        </div>
        
        <div id="object-container">
            
            <!-- Layer 1: Clean -->
            <img id="layer-clean" class="object-layer" alt="Stage 1: Clean">

            <!-- Layer 2: Decay I -->
            <img id="layer-decay1" class="object-layer" alt="Stage 2: Decay I" style="opacity: 0;">
            
            <!-- Layer 3: Decay II -->
            <img id="layer-decay2" class="object-layer" alt="Stage 3: Decay II" style="opacity: 0;">
            
            <!-- Layer 4: Catastrophe -->
            <img id="layer-catastrophe" class="object-layer" alt="Stage 4: Catastrophe" style="opacity: 0;">
            
            <!-- Layer 5: Video Overlay (Masked) -->
            <video id="layer-video" class="object-layer" loop muted playsinline style="opacity: 0; width: 100%; height: 100%;">
                 <!-- Source tag set by JS -->
            </video>
            
        </div>
        
        <!-- Instructions -->
        <p id="zoom-prompt" class="instruction-text absolute bottom-10 text-lg animate-pulse text-gray-400 mono-font tracking-widest">SCROLL / PINCH TO ZOOM • DRAG TO PAN</p>
        <p id="double-click-prompt" class="instruction-text absolute bottom-10 text-lg text-green-400 mono-font tracking-widest hidden-opacity font-bold">DOUBLE-CLICK / TAP TO ACCESS DATA</p>
    </div>

    <!-- Stage 3: Data Screen -->
    <div id="data-screen" class="screen justify-start p-4 md:p-8" ondblclick="returnToSelection()" dir="ltr">
        <div class="w-full max-w-[1600px] mx-auto flex flex-col h-full">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-4 border-b border-white pb-2 shrink-0">
                <h1 class="text-2xl md:text-4xl font-bold tracking-wider" id="data-title">ANALYSIS COMPLETE</h1>
                <span class="text-xs md:text-sm text-gray-400 mono-font mt-1 md:mt-0">ID: <span id="data-id-display">00</span></span>
            </div>
            
            <div class="flex flex-col md:flex-row flex-grow overflow-hidden h-full gap-4 md:gap-6">
                
                <!-- Decay Stages List (Bottom on Mobile, Left on Desktop) -->
                <div class="w-full md:w-64 flex-shrink-0 order-3 md:order-1 flex flex-col h-auto md:h-full">
                    <h2 class="text-sm md:text-lg mb-2 md:mb-4 text-gray-300 tracking-widest border-b border-gray-800 pb-1 hidden md:block">DECAY STAGES</h2>
                    <div id="stage-selection-list">
                        <!-- Stage buttons -->
                    </div>
                    <p class="mt-2 md:mt-4 text-[10px] md:text-xs text-gray-600 text-center uppercase tracking-widest cursor-pointer" onclick="returnToSelection()">Double-tap to Return</p>
                </div>

                <!-- Right Panel: Main Display & Log -->
                <div class="flex-grow order-1 md:order-2 h-full min-w-0 flex flex-col overflow-hidden">
                    <div class="data-content-wrapper">
                        <div class="data-panel flex justify-center items-center" id="data-main-image-container">
                            <img id="data-stage-image" alt="Selected Decay Stage">
                        </div>
                        
                        <div class="data-panel flex flex-col overflow-hidden">
                            <h2 class="text-sm md:text-lg mb-2 md:mb-3 border-b border-gray-700 pb-2 text-gray-300 tracking-widest">
                                LOG ENTRY: <span id="log-stage-name" class="text-white font-bold">CATASTROPHE</span>
                            </h2>
                            <div class="flex-grow overflow-hidden relative">
                                <pre id="data-log"></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // --- Global Configuration ---
        const MAX_ZOOM = 20.0;
        const TRANSITION_ZOOM_LEVELS = {
            CLEAN: 1.0, 
            DECAY1_START: 5.0, 
            DECAY2_START: 10.0, 
            CATASTROPHE_START: 20.0 
        };
        
        // OBJECT DATA
        const OBJECT_DATA = [
            { 
                id: 0, 
                name: "Olive Tree", 
                clean: "object0_clean.png", 
                decay1: "object0_rust1.png", 
                decay2: "object0_rust2.png", 
                catastrophe: "object0_rust3.png", 
                video: "rust_video.mp4", 
                logs: {
                    clean: "ANALYSIS LOG [ID:00 - OLIVE TREE]\nSTAGE: CLEAN / BASELINE\n================================\n\n[TECHNICAL DATA]\n> OXIDATION RATE: 0.0% (Nominal)\n> EST. TIME ELAPSED: 0 Years\n> SURFACE COLOR: #556B2F (Dark Olive Green)\n> TEXTURE CLASS: Smooth / Organic\n\n[STATUS: STABLE]\nSpecimen exhibits complete structural integrity.",
                    decay1: "ANALYSIS LOG [ID:00 - OLIVE TREE]\nSTAGE: DECAY I\n================================\n\n[TECHNICAL DATA]\n> OXIDATION RATE: 12.4% (Surface Weathering)\n> EST. TIME ELAPSED: ~50 Years\n> SURFACE COLOR: #8B4513 (Saddle Brown)\n> TEXTURE CLASS: Rough / Dehydrated\n\n[STATUS: MINOR DEGRADATION]\nInitial signs of dehydration detected in outer layers.",
                    decay2: "ANALYSIS LOG [ID:00 - OLIVE TREE]\nSTAGE: DECAY II\n================================\n\n[TECHNICAL DATA]\n> OXIDATION RATE: 45.8% (Structural Rot)\n> EST. TIME ELAPSED: ~150 Years\n> SURFACE COLOR: #3E2723 (Black Bean)\n> TEXTURE CLASS: Splintered / Brittle\n\n[STATUS: ADVANCED DECAY]\nDeep fissures detected. Core stability reduced by 40%.",
                    catastrophe: "ANALYSIS LOG [ID:00 - OLIVE TREE]\nSTAGE: CATASTROPHE\n================================\n\n[TECHNICAL DATA]\n> OXIDATION RATE: 98.2% (Total Petrification)\n> EST. TIME ELAPSED: ~450 Years\n> SURFACE COLOR: #1A1A1A (Charcoal)\n> TEXTURE CLASS: Ash / Dust\n\n[STATUS: BIOLOGICAL CESSATION]\nLife functions terminated. Structural collapse imminent."
                }
            },
            { 
                id: 1, 
                name: "Planet Earth", 
                clean: "object1_clean.png", 
                decay1: "object1_rust1.png", 
                decay2: "object1_rust2.png", 
                catastrophe: "object1_rust3.png", 
                video: "rust_video.mp4", 
                logs: {
                    clean: "ANALYSIS LOG [ID:01 - PLANET EARTH]\nSTAGE: CLEAN / BASELINE\n=================================\n\n[TECHNICAL DATA]\n> OXIDATION RATE: 0.0% (Stable)\n> EST. TIME ELAPSED: 0 Years\n\n[STATUS: HABITABLE]\nAtmospheric composition nitrogen-oxygen balance stable.",
                    decay1: "ANALYSIS LOG [ID:01 - PLANET EARTH]\nSTAGE: DECAY I\n=================================\n\n[TECHNICAL DATA]\n> OXIDATION RATE: 28.5% (Atmospheric Haze)\n> EST. TIME ELAPSED: ~30 Years\n\n[STATUS: WARNING]\nGlobal temperature anomaly +1.5°C. Cloud cover thickening.",
                    decay2: "ANALYSIS LOG [ID:01 - PLANET EARTH]\nSTAGE: DECAY II\n=================================\n\n[TECHNICAL DATA]\n> OXIDATION RATE: 65.0% (Biosphere Collapse)\n> EST. TIME ELAPSED: ~75 Years\n\n[STATUS: CRITICAL]\nRunaway greenhouse effect. Oceans evaporating.",
                    catastrophe: "ANALYSIS LOG [ID:01 - PLANET EARTH]\nSTAGE: CATASTROPHE\n=================================\n\n[TECHNICAL DATA]\n> OXIDATION RATE: 99.9% (Planetary Death)\n> EST. TIME ELAPSED: ~100+ Years\n\n[STATUS: SYSTEM FAILURE]\nAtmosphere stripped. Surface uninhabitable. Tectonic lock."
                }
            },
             { 
                id: 2, 
                name: "Wax Candle", 
                clean: "object2_clean.png", 
                decay1: "object2_rust1.png", 
                decay2: "object2_rust2.png", 
                catastrophe: "object2_rust3.png", 
                video: "rust_video.mp4", 
                logs: {
                    clean: "ANALYSIS LOG [ID:02 - WAX CANDLE]\nSTAGE: CLEAN / BASELINE\n===============================\n\n[TECHNICAL DATA]\n> OXIDATION RATE: 0.0% (Inert)\n> EST. TIME ELAPSED: 0 Hours\n\n[STATUS: PRISTINE]\nHydrocarbon structure solid. Wick integrity 100%.",
                    decay1: "ANALYSIS LOG [ID:02 - WAX CANDLE]\nSTAGE: DECAY I\n===============================\n\n[TECHNICAL DATA]\n> OXIDATION RATE: 15.0% (Surface Softening)\n> EST. TIME ELAPSED: ~12 Hours\n\n[STATUS: WEATHERING]\nSurface accumulating environmental dust. Slight deformation.",
                    decay2: "ANALYSIS LOG [ID:02 - WAX CANDLE]\nSTAGE: DECAY II\n===============================\n\n[TECHNICAL DATA]\n> OXIDATION RATE: 55.0% (Structural Warp)\n> EST. TIME ELAPSED: ~24 Hours\n\n[STATUS: MELTDOWN]\nCore integrity failing. Wick buried in deformed wax.",
                    catastrophe: "ANALYSIS LOG [ID:02 - WAX CANDLE]\nSTAGE: CATASTROPHE\n===============================\n\n[TECHNICAL DATA]\n> OXIDATION RATE: 100% (Amorphous Mass)\n> EST. TIME ELAPSED: ~48 Hours\n\n[STATUS: IRREVERSIBLE]\nComplete loss of form. Chemical structure degraded to carbon residue."
                }
            },
            { 
                id: 3, 
                name: "Human Subject", 
                clean: "object3_clean.png", 
                decay1: "object3_rust1.png", 
                decay2: "object3_rust2.png", 
                catastrophe: "object3_rust3.png", 
                video: "rust_video.mp4", 
                logs: {
                    clean: "ANALYSIS LOG [ID:03 - HUMAN SUBJECT]\nSTAGE: CLEAN / BASELINE\n==================================\n\n[TECHNICAL DATA]\n> OXIDATION RATE: 0.0% (Homeostasis)\n> EST. TIME ELAPSED: 0 Years\n\n[STATUS: VITAL]\nCellular regeneration active. Metabolic functions nominal.",
                    decay1: "ANALYSIS LOG [ID:03 - HUMAN SUBJECT]\nSTAGE: DECAY I\n==================================\n\n[TECHNICAL DATA]\n> OXIDATION RATE: 22.0% (Senescence Start)\n> EST. TIME ELAPSED: ~40 Years\n\n[STATUS: AGING]\nDermal elasticity reducing. Collagen production slowing.",
                    decay2: "ANALYSIS LOG [ID:03 - HUMAN SUBJECT]\nSTAGE: DECAY II\n==================================\n\n[TECHNICAL DATA]\n> OXIDATION RATE: 60.0% (Tissue Necrosis)\n> EST. TIME ELAPSED: ~70 Years\n\n[STATUS: FAILING]\nSystemic organ failure initiating. Regenerative capacity < 20%.",
                    catastrophe: "ANALYSIS LOG [ID:03 - HUMAN SUBJECT]\nSTAGE: CATASTROPHE\n==================================\n\n[TECHNICAL DATA]\n> OXIDATION RATE: 100% (Dust Conversion)\n> EST. TIME ELAPSED: ~100+ Years\n\n[STATUS: TERMINATED]\nBiological cessation complete. Matter converted to inorganic dust. Consciousness trace: None."
                }
            }
        ];
        

        // --- State Variables ---
        let currentZoom = 1.0;
        let panX = 0;
        let panY = 0;
        let selectedObjectId = null;
        let maxZoomReached = false; 
        let typingInterval = null; 
        
        // Drag/Touch Interaction
        let isDragging = false;
        let lastMouseX = 0;
        let lastMouseY = 0;
        let lastTapTime = 0; 
        
        // Pinch Zoom Interaction
        let initialPinchDistance = null;
        let initialZoomBeforePinch = 1.0;

        // Elements 
        let decay1Layer, decay2Layer, catastropheLayer, videoLayer; 
        let zoomContainer;

        // --- Typewriter Effect ---
        function typeWriter(text, elementId, speed = 10) {
            const element = document.getElementById(elementId);
            if (!element) return;
            element.innerHTML = '';
            if (typingInterval) clearInterval(typingInterval);

            const cursor = document.createElement('span');
            cursor.className = 'typing-cursor';
            element.appendChild(cursor);

            let i = 0;
            typingInterval = setInterval(() => {
                if (i < text.length) {
                    cursor.insertAdjacentHTML('beforebegin', text.charAt(i));
                    i++;
                    element.scrollTop = element.scrollHeight;
                } else {
                    clearInterval(typingInterval);
                    cursor.remove();
                }
            }, speed);
        }

        // --- Core Functions ---

        function setActiveScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        function initSelectionScreen() {
            const selectionContainer = document.getElementById('object-selection');
            selectionContainer.innerHTML = '';
            
            OBJECT_DATA.forEach(obj => {
                const button = document.createElement('button');
                button.className = 'select-btn';
                button.setAttribute('onclick', `selectObject(${obj.id})`);
                
                button.innerHTML = `
                    <img src="${obj.clean}" 
                         onerror="this.onerror=null; this.src='https://placehold.co/120x120/000000/FFFFFF?text=${obj.name}'" 
                         alt="${obj.name}" 
                         class="btn-image">
                    <span class="mt-4 text-sm text-white tracking-widest uppercase font-semibold text-center leading-tight">${obj.name}</span>
                `;
                selectionContainer.appendChild(button);
            });
            
            // Reset State
            currentZoom = 1.0;
            panX = 0;
            panY = 0;
            maxZoomReached = false;
            initialPinchDistance = null;
            
            updateZoomPrompt();
            if (typingInterval) clearInterval(typingInterval);
            
            setActiveScreen('selection-screen');
        }

        function selectObject(id) {
            selectedObjectId = id;
            const data = OBJECT_DATA.find(o => o.id === id);
            
            // Setup Layers
            document.getElementById('layer-clean').src = data.clean;
            if (decay1Layer) decay1Layer.src = data.decay1;
            if (decay2Layer) decay2Layer.src = data.decay2;
            if (catastropheLayer) catastropheLayer.src = data.catastrophe;
            
            document.getElementById('object-name-display').textContent = data.name.toUpperCase();

            // Video Setup & MASKING
            if (videoLayer) {
                const sourceElement = document.createElement('source');
                sourceElement.src = data.video;
                sourceElement.type = 'video/mp4';
                videoLayer.innerHTML = ''; 
                videoLayer.appendChild(sourceElement);
                videoLayer.load();
                videoLayer.play().catch(e => {}); 
                videoLayer.style.opacity = 0;
                
                const maskUrl = `url('${data.clean}')`;
                videoLayer.style.webkitMaskImage = maskUrl;
                videoLayer.style.maskImage = maskUrl;
                videoLayer.style.mixBlendMode = 'overlay';
            }

            // Reset View
            currentZoom = 1.0;
            panX = 0;
            panY = 0;
            maxZoomReached = false;
            
            if (zoomContainer) zoomContainer.classList.remove('crumbling');

            updateVisuals();
            updateZoomPrompt();
            
            setActiveScreen('interactive-screen');
        }

        // --- Logic: Zoom & Interaction ---
        
        function updateVisuals() {
            if (zoomContainer) {
                // We divide by currentZoom for panX/Y logic, so here we apply them directly.
                // If we want 1:1 panning, the translation should be scaled by 1/zoom in CSS, or the logic in handlers should change.
                // With `translate(${panX}px, ${panY}px) scale(${currentZoom})`, panX is in "scene coordinates".
                // In handlers, we did `panX += deltaX / currentZoom`. This works.
                
                // Constraint Check before applying
                const containerDim = document.getElementById('object-container').offsetWidth || 300; 
                // Allow panning up to the edges of the zoomed image
                const maxPan = (containerDim * (currentZoom - 1)) / 2; 
                
                if (currentZoom > 1.0) {
                    panX = Math.max(-maxPan, Math.min(maxPan, panX));
                    panY = Math.max(-maxPan, Math.min(maxPan, panY));
                } else {
                    panX = 0;
                    panY = 0;
                }

                zoomContainer.style.transform = `translate(-50%, -50%) translate(${panX}px, ${panY}px) scale(${currentZoom})`;
            }
            document.getElementById('zoom-level').textContent = currentZoom.toFixed(1);
            updateLayerOpacities();
        }

        function applyZoom(delta) {
            let newZoom = currentZoom + delta;
            newZoom = Math.max(1.0, Math.min(MAX_ZOOM, newZoom));
            currentZoom = newZoom;
            
            // Logic for visual update
            updateVisuals();
            handleZoomEndLogic();
        }

        // Wheel (Mouse) - ZOOM
        function handleWheel(event) {
            event.preventDefault();
            const delta = event.deltaY * -0.01; 
            applyZoom(delta);
        }

        // Mouse Drag - PAN
        function handleMouseDown(event) {
            if (currentZoom > 1.0) {
                isDragging = true;
                lastMouseX = event.clientX;
                lastMouseY = event.clientY;
                document.body.style.cursor = 'grabbing';
            }
        }

        function handleMouseMove(event) {
            if (!isDragging) return;
            event.preventDefault();

            const currentX = event.clientX;
            const currentY = event.clientY;
            
            const deltaX = currentX - lastMouseX;
            const deltaY = currentY - lastMouseY;
            
            // Pan Logic: Move 1:1 with cursor
            // Since CSS applies scale AFTER translate, we divide by zoom to match cursor movement
            panX += deltaX / currentZoom;
            panY += deltaY / currentZoom;

            lastMouseX = currentX;
            lastMouseY = currentY;
            
            updateVisuals();
        }

        // Touch Start (Pan or Pinch)
        function handleTouchStart(event) {
            if (event.touches.length === 1) {
                isDragging = true;
                lastMouseX = event.touches[0].clientX;
                lastMouseY = event.touches[0].clientY;
            } else if (event.touches.length === 2) {
                isDragging = false; // Switch to zoom mode
                initialPinchDistance = getDistance(event.touches);
                initialZoomBeforePinch = currentZoom;
            }
        }
        
        // Touch Move (Pan or Pinch)
        function handleTouchMove(event) {
            event.preventDefault();
            
            // 1. Pinch Zoom
            if (event.touches.length === 2 && initialPinchDistance) {
                const currentDist = getDistance(event.touches);
                const scaleRatio = currentDist / initialPinchDistance;
                
                let newZoom = initialZoomBeforePinch * scaleRatio;
                newZoom = Math.max(1.0, Math.min(MAX_ZOOM, newZoom));
                
                currentZoom = newZoom;
                updateVisuals();
                handleZoomEndLogic();
                return;
            }

            // 2. Pan (One finger)
            if (event.touches.length === 1 && isDragging && currentZoom > 1.0) {
                const touch = event.touches[0];
                const deltaX = touch.clientX - lastMouseX;
                const deltaY = touch.clientY - lastMouseY;
                
                panX += deltaX / currentZoom;
                panY += deltaY / currentZoom;
                
                lastMouseX = touch.clientX;
                lastMouseY = touch.clientY;
                
                updateVisuals();
            }
        }
        
        function handleTouchEnd(event) {
            isDragging = false;
            if (event.touches.length < 2) {
                initialPinchDistance = null;
            }
            
            // Mobile Double Tap
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTapTime;
            if (tapLength < 300 && tapLength > 0) {
                handleDoubleClick();
                event.preventDefault();
            }
            lastTapTime = currentTime;
        }

        function handleMouseUp() {
            isDragging = false;
            document.body.style.cursor = 'grab';
        }
        
        function getDistance(touches) {
            const dx = touches[0].clientX - touches[1].clientX;
            const dy = touches[0].clientY - touches[1].clientY;
            return Math.sqrt(dx * dx + dy * dy);
        }

        // --- Transition Logic ---
        function getLayerProgress(minZoom, maxZoom) {
            if (currentZoom < minZoom) return 0;
            if (currentZoom >= maxZoom) return 1;
            return (currentZoom - minZoom) / (maxZoom - minZoom);
        }

        function updateLayerOpacities() {
            if (maxZoomReached) {
                if (catastropheLayer) catastropheLayer.style.opacity = 1.0;
                if (videoLayer) videoLayer.style.opacity = 0.3;
                
                if (decay1Layer) decay1Layer.style.opacity = Math.min(1.0, getLayerProgress(1.0, 5.0));
                if (decay2Layer) decay2Layer.style.opacity = Math.min(1.0, getLayerProgress(5.0, 10.0));
                return; 
            }
            
            if (decay1Layer) decay1Layer.style.opacity = getLayerProgress(1.0, 5.0);
            if (decay2Layer) decay2Layer.style.opacity = getLayerProgress(5.0, 10.0);
            if (catastropheLayer) catastropheLayer.style.opacity = getLayerProgress(10.0, 20.0);

            if (videoLayer) {
                const videoProgress = getLayerProgress(5.0, MAX_ZOOM);
                videoLayer.style.opacity = videoProgress * 0.9; 
            }
        }

        function handleZoomEndLogic() {
            if (currentZoom >= MAX_ZOOM) {
                maxZoomReached = true;
                if (catastropheLayer) catastropheLayer.style.opacity = 1.0;
            } 
            updateZoomPrompt();
        }
        
        function updateZoomPrompt() {
            const scrollPrompt = document.getElementById('zoom-prompt');
            const clickPrompt = document.getElementById('double-click-prompt');
            
            if (maxZoomReached && currentZoom <= 1.05) {
                scrollPrompt.style.opacity = '0';
                clickPrompt.style.opacity = '1';
                document.body.style.cursor = 'pointer';
            } else {
                scrollPrompt.style.opacity = '1';
                scrollPrompt.textContent = maxZoomReached ? "ZOOM OUT TO COMPLETE" : "SCROLL / PINCH TO ZOOM • DRAG TO PAN";
                clickPrompt.style.opacity = '0';
                document.body.style.cursor = isDragging ? 'grabbing' : 'grab';
            }
        }

        // --- Data Screen ---
        function updateDataScreen(id) {
            const data = OBJECT_DATA.find(o => o.id === id);
            
            if (videoLayer) {
                videoLayer.pause();
                videoLayer.currentTime = 0;
            }

            document.getElementById('data-title').textContent = `${data.name.toUpperCase()} | ANALYSIS COMPLETE`;
            document.getElementById('data-id-display').textContent = String(id).padStart(2, '0');
            
            setupDataStageSelectors(data);
            
            const logText = data.logs['catastrophe'];
            typeWriter(logText, 'data-log');
            
            setActiveScreen('data-screen');
        }

        function setupDataStageSelectors(data) {
            const listContainer = document.getElementById('stage-selection-list');
            listContainer.innerHTML = '';
            
            const stages = [
                { key: 'clean', name: 'CLEAN', file: data.clean },
                { key: 'decay1', name: 'DECAY I', file: data.decay1 },
                { key: 'decay2', name: 'DECAY II', file: data.decay2 },
                { key: 'catastrophe', name: 'CATASTROPHE', file: data.catastrophe }
            ];

            stages.forEach(stage => {
                const button = document.createElement('div');
                const isActive = stage.key === 'catastrophe' ? 'active' : ''; 
                button.className = `stage-selector ${isActive}`;
                button.setAttribute('onclick', `selectDataStage('${stage.key}', '${stage.name}', '${stage.file}')`);
                
                button.innerHTML = `
                    <img src="${stage.file}" 
                         onerror="this.onerror=null; this.src='https://placehold.co/120x120/000000/FFFFFF?text=${stage.name}'" 
                         alt="${stage.name}">
                `;
                listContainer.appendChild(button);
            });
            
            selectDataStage('catastrophe', 'CATASTROPHE (FINAL STATE)', data.catastrophe);
        }

        function selectDataStage(key, name, file) {
            const mainImage = document.getElementById('data-stage-image');
            mainImage.src = file;
            mainImage.onerror = function() {
                this.onerror = null; 
                this.src = `https://placehold.co/400x400/000000/FFFFFF?text=${name}`;
            }
            
            document.getElementById('log-stage-name').textContent = name;

            document.querySelectorAll('.stage-selector').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.stage-selector[onclick*='${key}']`).classList.add('active');
            
            const data = OBJECT_DATA.find(o => o.id === selectedObjectId);
            if (data && data.logs && data.logs[key]) {
                typeWriter(data.logs[key], 'data-log');
            }
        }

        function handleDoubleClick() {
            if (selectedObjectId !== null && maxZoomReached && currentZoom <= 1.05) {
                updateDataScreen(selectedObjectId);
            }
        }

        function returnToSelection() {
            const log = document.getElementById('data-log');
            if(log) log.scrollTop = 0;
            initSelectionScreen();
        }

        // --- Init ---
        window.onload = function() {
            decay1Layer = document.getElementById('layer-decay1'); 
            decay2Layer = document.getElementById('layer-decay2'); 
            catastropheLayer = document.getElementById('layer-catastrophe'); 
            videoLayer = document.getElementById('layer-video'); 
            zoomContainer = document.getElementById('object-container');
            
            initSelectionScreen();
        };
    </script>
</body>
</html>