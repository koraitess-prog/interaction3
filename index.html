<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rust Decay Study | Interactive Analysis</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Import Scientific Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Share+Tech+Mono&display=swap');
        
        body {
            font-family: 'Rajdhani', sans-serif; 
            overflow: hidden; 
            background-color: #000;
            color: #FFF;
        }
        
        #data-log, #object-name-display-container, .mono-font {
            font-family: 'Share Tech Mono', monospace; 
        }

        /* --- Global Screen Transition --- */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 1.0s ease-in-out; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        .screen.active {
            opacity: 1;
            pointer-events: auto;
            z-index: 20;
        }
        
        /* --- Stage 1: Selection Screen --- */
        #selection-title {
            font-weight: 700; 
            letter-spacing: 0.15em;
            text-transform: uppercase;
        }

        .select-btn {
            width: 160px;
            height: 160px;
            background-color: #0a0a0a;
            border: 1px solid #444;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }
        
        .select-btn::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 10px;
            height: 10px;
            border-bottom: 2px solid #666;
            border-right: 2px solid #666;
            transition: all 0.3s;
        }

        .select-btn:hover {
            transform: translateY(-5px);
            border-color: #FFFFFF; 
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.15);
        }
        
        .select-btn:hover::after {
            border-color: #FFF;
            width: 100%;
            height: 100%;
        }

        .btn-image {
            width: 85%; 
            height: 85%; 
            object-fit: contain; 
        }
        
        /* --- Stage 2: Interactive Screen --- */
        #interactive-screen {
            cursor: grab; 
            overflow: hidden;
        }
        
        #interactive-screen:active {
            cursor: grabbing;
        }

        #object-container {
            position: absolute; 
            top: 50%;
            left: 50%;
            width: 80vmin; 
            height: 80vmin;
            display: flex;
            justify-content: center;
            align-items: center;
            user-select: none; 
            transform: translate(-50%, -50%) scale(1); 
            will-change: transform; 
        }
        
        .object-layer {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: contain; 
            transition: opacity 0.1s linear; 
            z-index: 2; 
            pointer-events: none; 
        }

        /* VIDEO OVERLAY STYLING - RESTORED */
        #layer-video {
            z-index: 3; 
            mix-blend-mode: overlay; /* Blends nicely with rust textures */
            pointer-events: none;
            /* Masking ensures video stays ON the object */
            -webkit-mask-size: contain;
            mask-size: contain;
            -webkit-mask-position: center;
            mask-position: center;
            -webkit-mask-repeat: no-repeat;
            mask-repeat: no-repeat;
        }
        
        /* --- Stage 3: Data Screen --- */
        #data-screen {
            background-color: #000;
            color: #FFFFFF; 
            overflow: hidden; 
            padding: 30px;
            height: 100vh; 
        }
        
        .data-panel {
            border: 1px solid #FFFFFF; 
            background-color: rgba(10, 10, 10, 0.8); 
            padding: 20px;
            position: relative;
        }
        
        .data-panel::before {
            content: '';
            position: absolute;
            top: -1px; left: -1px;
            width: 20px; height: 20px;
            border-top: 2px solid #FFF;
            border-left: 2px solid #FFF;
        }
        .data-panel::after {
            content: '';
            position: absolute;
            bottom: -1px; right: -1px;
            width: 20px; height: 20px;
            border-bottom: 2px solid #FFF;
            border-right: 2px solid #FFF;
        }

        #data-log {
             white-space: pre-wrap; 
             line-height: 1.6;
             direction: ltr; 
             text-align: left;
             font-size: 1.1rem; 
             height: 100%; 
             overflow-y: auto; 
             color: #ddd;
        }
        
        #data-log::-webkit-scrollbar { width: 6px; }
        #data-log::-webkit-scrollbar-track { background: #111; }
        #data-log::-webkit-scrollbar-thumb { background: #444; }

        .typing-cursor {
            display: inline-block;
            width: 8px;
            height: 1.1rem;
            background-color: white;
            animation: blink 0.8s infinite;
            margin-left: 4px;
            vertical-align: middle;
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        /* STAGE SELECTOR: Flex column to fit all items */
        #stage-selection-list {
            display: flex;
            flex-direction: column;
            height: 100%; 
            gap: 10px; 
            overflow: hidden;
            padding: 2px;
        }

        .stage-selector {
            flex: 1; 
            width: 100%; 
            min-height: 0; 
            border: 1px solid #333; 
            transition: all 0.2s ease;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center; 
            background: #050505;
            position: relative;
        }
        .stage-selector:hover {
            border-color: #888;
            background-color: #111;
        }
        .stage-selector.active {
            border-color: #FFF;
            background-color: #1a1a1a;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
        }
        
        .stage-selector img {
            width: 100%;
            height: 100%;
            object-fit: contain; 
            padding: 8px;
        }

        #data-main-image-container {
            border: 1px solid #333;
            width: 100%;
            height: 100%; 
            margin-bottom: 0; 
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        #data-stage-image {
            object-fit: contain; 
            width: 100%; 
            height: 100%;
            max-height: 100%;
        }

        .data-content-wrapper {
            display: grid;
            grid-template-columns: 1fr; 
            grid-template-rows: 1fr 1fr; 
            gap: 1.5rem;
            height: 100%;
            overflow: hidden; 
        }

        @media (min-width: 1024px) {
            .data-content-wrapper {
                grid-template-rows: 1.2fr 0.8fr; 
            }
        }
        
        #object-name-display-container {
            direction: ltr;
            text-align: left;
            left: 24px;
            right: auto;
            top: 24px;
            pointer-events: none; 
        }
        
        .instruction-text {
            pointer-events: none; 
        }
        
        .hidden-opacity {
            opacity: 0;
            transition: opacity 0.5s;
        }
    </style>
</head>
<body class="bg-black text-white">

    <!-- Stage 1: Selection Screen -->
    <div id="selection-screen" class="screen active" dir="ltr">
        <h1 id="selection-title" class="text-5xl md:text-7xl mb-12 text-white tracking-widest font-bold">RUST DECAY STUDY</h1>
        <p class="text-xl mb-12 text-gray-400 font-light tracking-wider">SELECT SPECIMEN FOR ANALYSIS</p>

        <div id="object-selection" class="flex flex-wrap justify-center gap-8 p-4">
            <!-- Buttons injected by JS -->
        </div>
        <p class="mt-12 text-xs text-gray-600 tracking-widest uppercase">Scroll to Zoom • Drag to Pan</p>
    </div>

    <!-- Stage 2: Interactive Screen -->
    <div id="interactive-screen" class="screen" 
         onwheel="handleWheel(event)" 
         onmousedown="handleMouseDown(event)"
         onmousemove="handleMouseMove(event)"
         onmouseup="handleMouseUp(event)"
         onmouseleave="handleMouseUp(event)"
         ontouchstart="handleTouchStart(event)"
         ontouchmove="handleTouchMove(event)"
         ontouchend="handleMouseUp(event)"
         ondblclick="handleDoubleClick()"
         dir="ltr">
         
        <p id="object-name-display-container" class="text-xl absolute top-6 left-6 z-30 text-white tracking-wider">
            <span id="object-name-display" class="font-bold border-b border-white pb-1"></span> 
            <span class="text-gray-400 ml-2 text-sm">ZOOM: <span id="zoom-level">1.0</span>x</span>
        </p>
        
        <div id="object-container">
            
            <!-- Layer 1: Clean -->
            <img id="layer-clean" class="object-layer" alt="Stage 1: Clean">

            <!-- Layer 2: Decay I -->
            <img id="layer-decay1" class="object-layer" alt="Stage 2: Decay I" style="opacity: 0;">
            
            <!-- Layer 3: Decay II -->
            <img id="layer-decay2" class="object-layer" alt="Stage 3: Decay II" style="opacity: 0;">
            
            <!-- Layer 4: Catastrophe -->
            <img id="layer-catastrophe" class="object-layer" alt="Stage 4: Catastrophe" style="opacity: 0;">
            
            <!-- Layer 5: Video Overlay (Masked to object) - RESTORED -->
            <video id="layer-video" class="object-layer" loop muted playsinline style="opacity: 0; width: 100%; height: 100%;">
                 <!-- Source tag set by JS -->
            </video>
            
        </div>
        
        <!-- Instructions -->
        <p id="zoom-prompt" class="instruction-text absolute bottom-10 text-lg animate-pulse text-gray-400 mono-font tracking-widest">SCROLL UP TO ANALYZE DECAY</p>
        <p id="double-click-prompt" class="instruction-text absolute bottom-10 text-lg text-green-400 mono-font tracking-widest hidden-opacity font-bold border border-green-400 px-4 py-2 bg-black/50">DOUBLE-CLICK TO ACCESS DATA</p>
    </div>

    <!-- Stage 3: Data Screen -->
    <div id="data-screen" class="screen justify-start p-8" ondblclick="returnToSelection()" dir="ltr">
        <div class="w-full max-w-[1600px] mx-auto flex flex-col h-full">
            <div class="flex justify-between items-end mb-6 border-b border-white pb-2">
                <h1 class="text-4xl font-bold tracking-wider" id="data-title">ANALYSIS COMPLETE</h1>
                <span class="text-sm text-gray-400 mono-font">ID: <span id="data-id-display">00</span></span>
            </div>
            
            <div class="flex flex-col md:flex-row flex-grow overflow-hidden h-full gap-6">
                
                <!-- Left Panel: Decay Stages List -->
                <div class="w-full md:w-64 flex-shrink-0 order-2 md:order-1 h-full flex flex-col">
                    <h2 class="text-lg mb-4 text-gray-300 tracking-widest border-b border-gray-800 pb-1">DECAY STAGES</h2>
                    <div id="stage-selection-list">
                        <!-- Stage buttons -->
                    </div>
                    <p class="mt-4 text-xs text-gray-600 text-center uppercase tracking-widest">Double-click to Return</p>
                </div>

                <!-- Right Panel: Main Display & Log -->
                <div class="flex-grow order-1 md:order-2 h-full min-w-0">
                    <div class="data-content-wrapper">
                        <!-- 1. Main Image Display -->
                        <div class="data-panel flex justify-center items-center" id="data-main-image-container">
                            <img id="data-stage-image" alt="Selected Decay Stage">
                        </div>
                        
                        <!-- 2. Log Analysis -->
                        <div class="data-panel flex flex-col overflow-hidden">
                            <h2 class="text-lg mb-3 border-b border-gray-700 pb-2 text-gray-300 tracking-widest">
                                LOG ENTRY: <span id="log-stage-name" class="text-white font-bold">CATASTROPHE</span>
                            </h2>
                            <div class="flex-grow overflow-hidden relative">
                                <pre id="data-log"></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // --- Global Configuration ---
        const MAX_ZOOM = 20.0;
        const TRANSITION_ZOOM_LEVELS = {
            CLEAN: 1.0, 
            DECAY1_START: 5.0, 
            DECAY2_START: 10.0, 
            CATASTROPHE_START: 20.0 
        };
        
        // OBJECT DATA - Using correct filenames from your structure
        const OBJECT_DATA = [
            { 
                id: 0, 
                name: "Olive Tree", 
                clean: "object0_clean.png", 
                decay1: "object0_rust1.png", 
                decay2: "object0_rust2.png", 
                catastrophe: "object0_rust3.png", 
                video: "rust_video.mp4", 
                logs: {
                    clean: "ANALYSIS LOG [ID:00 - OLIVE TREE]\nSTAGE: CLEAN / BASELINE\n================================\n\n[TECHNICAL DATA]\n> OXIDATION RATE: 0.0% (Nominal)\n> EST. TIME ELAPSED: 0 Years\n> SURFACE COLOR: #556B2F (Dark Olive Green)\n> TEXTURE CLASS: Smooth / Organic\n\n[STATUS: STABLE]\nSpecimen exhibits complete structural integrity. Cellular hydration at optimal levels (100%). No signs of external weathering or parasitic intrusion.\n\n[END OF LOG]",
                    decay1: "ANALYSIS LOG [ID:00 - OLIVE TREE]\nSTAGE: DECAY I\n================================\n\n[TECHNICAL DATA]\n> OXIDATION RATE: 12.4% (Surface Weathering)\n> EST. TIME ELAPSED: ~50 Years\n> SURFACE COLOR: #8B4513 (Saddle Brown)\n> TEXTURE CLASS: Rough / Dehydrated\n\n[STATUS: MINOR DEGRADATION]\nInitial signs of dehydration detected in outer layers. Bark integrity compromised by 15%. Micro-fractures appearing along the main trunk axis due to moisture loss.\n\n[END OF LOG]",
                    decay2: "ANALYSIS LOG [ID:00 - OLIVE TREE]\nSTAGE: DECAY II\n================================\n\n[TECHNICAL DATA]\n> OXIDATION RATE: 45.8% (Structural Rot)\n> EST. TIME ELAPSED: ~150 Years\n> SURFACE COLOR: #3E2723 (Black Bean)\n> TEXTURE CLASS: Splintered / Brittle\n\n[STATUS: ADVANCED DECAY]\nDeep fissures detected. Core stability reduced by 40%. Fungal colonization likely. Organic compounds breaking down into carbon-rich residue.\n\n[END OF LOG]",
                    catastrophe: "ANALYSIS LOG [ID:00 - OLIVE TREE]\nSTAGE: CATASTROPHE\n================================\n\n[TECHNICAL DATA]\n> OXIDATION RATE: 98.2% (Total Petrification)\n> EST. TIME ELAPSED: ~450 Years\n> SURFACE COLOR: #1A1A1A (Charcoal)\n> TEXTURE CLASS: Ash / Dust\n\n[STATUS: BIOLOGICAL CESSATION]\nLife functions terminated. Structural collapse imminent. Matter conversion to inorganic carbon dust complete. Specimen irretrievable.\n\n[END OF LOG]"
                }
            },
            { 
                id: 1, 
                name: "Planet Earth", 
                clean: "object1_clean.png", 
                decay1: "object1_rust1.png", 
                decay2: "object1_rust2.png", 
                catastrophe: "object1_rust3.png", 
                video: "rust_video.mp4", 
                logs: {
                    clean: "ANALYSIS LOG [ID:01 - PLANET EARTH]\nSTAGE: CLEAN / BASELINE\n=================================\n\n[TECHNICAL DATA]\n> OXIDATION RATE: 0.0% (Stable)\n> EST. TIME ELAPSED: 0 Years\n> SURFACE COLOR: #1E90FF (Dodger Blue)\n> TEXTURE CLASS: Fluid / Dynamic\n\n[STATUS: HABITABLE]\nAtmospheric composition nitrogen-oxygen balance stable. Hydro-sphere covers 71% of surface. Biosphere activity nominal.\n\n[END OF LOG]",
                    decay1: "ANALYSIS LOG [ID:01 - PLANET EARTH]\nSTAGE: DECAY I\n=================================\n\n[TECHNICAL DATA]\n> OXIDATION RATE: 28.5% (Atmospheric Haze)\n> EST. TIME ELAPSED: ~30 Years\n> SURFACE COLOR: #708090 (Slate Gray)\n> TEXTURE CLASS: Hazy / Polluted\n\n[STATUS: WARNING]\nGlobal temperature anomaly +1.5°C. Cloud cover thickening with particulate matter. Ocean acidification initiating coral bleaching events.\n\n[END OF LOG]",
                    decay2: "ANALYSIS LOG [ID:01 - PLANET EARTH]\nSTAGE: DECAY II\n=================================\n\n[TECHNICAL DATA]\n> OXIDATION RATE: 65.0% (Biosphere Collapse)\n> EST. TIME ELAPSED: ~75 Years\n> SURFACE COLOR: #B22222 (Firebrick)\n> TEXTURE CLASS: Scorched / Volatile\n\n[STATUS: CRITICAL]\nRunaway greenhouse effect. Oceans evaporating. Landmasses scorched by UV radiation. Biodiversity index approaching zero.\n\n[END OF LOG]",
                    catastrophe: "ANALYSIS LOG [ID:01 - PLANET EARTH]\nSTAGE: CATASTROPHE\n=================================\n\n[TECHNICAL DATA]\n> OXIDATION RATE: 99.9% (Planetary Death)\n> EST. TIME ELAPSED: ~100+ Years\n> SURFACE COLOR: #2F4F4F (Dark Slate)\n> TEXTURE CLASS: Barren / Cratered\n\n[STATUS: SYSTEM FAILURE]\nAtmosphere stripped. Surface uninhabitable. Tectonic lock. Planet classified as dead world. No recovery possible.\n\n[END OF LOG]"
                }
            },
             { 
                id: 2, 
                name: "Wax Candle", 
                clean: "object2_clean.png", 
                decay1: "object2_rust1.png", 
                decay2: "object2_rust2.png", 
                catastrophe: "object2_rust3.png", 
                video: "rust_video.mp4", 
                logs: {
                    clean: "ANALYSIS LOG [ID:02 - WAX CANDLE]\nSTAGE: CLEAN / BASELINE\n===============================\n\n[TECHNICAL DATA]\n> OXIDATION RATE: 0.0% (Inert)\n> EST. TIME ELAPSED: 0 Hours\n> SURFACE COLOR: #FFF8DC (Cornsilk)\n> TEXTURE CLASS: Smooth / Waxy\n\n[STATUS: PRISTINE]\nHydrocarbon structure solid. Wick integrity 100%. Potential energy stored and ready for combustion.\n\n[END OF LOG]",
                    decay1: "ANALYSIS LOG [ID:02 - WAX CANDLE]\nSTAGE: DECAY I\n===============================\n\n[TECHNICAL DATA]\n> OXIDATION RATE: 15.0% (Surface Softening)\n> EST. TIME ELAPSED: ~12 Hours\n> SURFACE COLOR: #F0E68C (Khaki)\n> TEXTURE CLASS: Tacky / Dust Accumulation\n\n[STATUS: WEATHERING]\nSurface accumulating environmental dust. Slight deformation due to ambient heat. Exterior sheen lost.\n\n[END OF LOG]",
                    decay2: "ANALYSIS LOG [ID:02 - WAX CANDLE]\nSTAGE: DECAY II\n===============================\n\n[TECHNICAL DATA]\n> OXIDATION RATE: 55.0% (Structural Warp)\n> EST. TIME ELAPSED: ~24 Hours\n> SURFACE COLOR: #DAA520 (Goldenrod)\n> TEXTURE CLASS: Deformed / Melted\n\n[STATUS: MELTDOWN]\nCore integrity failing. Wick buried in deformed wax. Material separation occurring. Chemical breakdown accelerating.\n\n[END OF LOG]",
                    catastrophe: "ANALYSIS LOG [ID:02 - WAX CANDLE]\nSTAGE: CATASTROPHE\n===============================\n\n[TECHNICAL DATA]\n> OXIDATION RATE: 100% (Amorphous Mass)\n> EST. TIME ELAPSED: ~48 Hours\n> SURFACE COLOR: #111111 (Soot Black)\n> TEXTURE CLASS: Sludge / Ash\n\n[STATUS: IRREVERSIBLE]\nComplete loss of form. Chemical structure degraded to carbon residue. Object unrecognizable.\n\n[END OF LOG]"
                }
            },
            { 
                id: 3, 
                name: "Human Subject", 
                clean: "object3_clean.png", 
                decay1: "object3_rust1.png", 
                decay2: "object3_rust2.png", 
                catastrophe: "object3_rust3.png", 
                video: "rust_video.mp4", 
                logs: {
                    clean: "ANALYSIS LOG [ID:03 - HUMAN SUBJECT]\nSTAGE: CLEAN / BASELINE\n==================================\n\n[TECHNICAL DATA]\n> OXIDATION RATE: 0.0% (Homeostasis)\n> EST. TIME ELAPSED: 0 Years\n> SURFACE COLOR: #FFE4C4 (Bisque)\n> TEXTURE CLASS: Elastic / Organic\n\n[STATUS: VITAL]\nCellular regeneration active. Metabolic functions nominal. Telomere length optimal. Organ systems functioning at peak efficiency.\n\n[END OF LOG]",
                    decay1: "ANALYSIS LOG [ID:03 - HUMAN SUBJECT]\nSTAGE: DECAY I\n==================================\n\n[TECHNICAL DATA]\n> OXIDATION RATE: 22.0% (Senescence Start)\n> EST. TIME ELAPSED: ~40 Years\n> SURFACE COLOR: #D2B48C (Tan)\n> TEXTURE CLASS: Weathered / Lines\n\n[STATUS: AGING]\nDermal elasticity reducing. Collagen production slowing. Oxidative stress markers detected in cellular samples.\n\n[END OF LOG]",
                    decay2: "ANALYSIS LOG [ID:03 - HUMAN SUBJECT]\nSTAGE: DECAY II\n==================================\n\n[TECHNICAL DATA]\n> OXIDATION RATE: 60.0% (Tissue Necrosis)\n> EST. TIME ELAPSED: ~70 Years\n> SURFACE COLOR: #8B4513 (Saddle Brown)\n> TEXTURE CLASS: Leathery / Rigid\n\n[STATUS: FAILING]\nSystemic organ failure initiating. Regenerative capacity < 20%. Skeletal structure visible through atrophied tissue.\n\n[END OF LOG]",
                    catastrophe: "ANALYSIS LOG [ID:03 - HUMAN SUBJECT]\nSTAGE: CATASTROPHE\n==================================\n\n[TECHNICAL DATA]\n> OXIDATION RATE: 100% (Dust Conversion)\n> EST. TIME ELAPSED: ~100+ Years\n> SURFACE COLOR: #2F4F4F (Dark Gray)\n> TEXTURE CLASS: Particulate / Bone\n\n[STATUS: TERMINATED]\nBiological cessation complete. Matter converted to inorganic dust. Consciousness trace: None.\n\n[END OF LOG]"
                }
            }
        ];
        

        // --- State Variables ---
        let currentZoom = 1.0;
        let panX = 0;
        let panY = 0;
        let selectedObjectId = null;
        let maxZoomReached = false; 
        let typingInterval = null; 
        
        // Drag Interaction
        let isDragging = false;
        let lastMouseX = 0;
        let lastMouseY = 0;

        // Elements 
        let decay1Layer, decay2Layer, catastropheLayer, videoLayer; 
        let zoomContainer;

        // --- Typewriter Effect ---
        function typeWriter(text, elementId, speed = 10) {
            const element = document.getElementById(elementId);
            if (!element) return;
            element.innerHTML = '';
            if (typingInterval) clearInterval(typingInterval);

            const cursor = document.createElement('span');
            cursor.className = 'typing-cursor';
            element.appendChild(cursor);

            let i = 0;
            typingInterval = setInterval(() => {
                if (i < text.length) {
                    cursor.insertAdjacentHTML('beforebegin', text.charAt(i));
                    i++;
                    element.scrollTop = element.scrollHeight;
                } else {
                    clearInterval(typingInterval);
                    cursor.remove();
                }
            }, speed);
        }

        // --- Core Functions ---

        function setActiveScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        function initSelectionScreen() {
            const selectionContainer = document.getElementById('object-selection');
            selectionContainer.innerHTML = '';
            
            OBJECT_DATA.forEach(obj => {
                const button = document.createElement('button');
                button.className = 'select-btn';
                button.setAttribute('onclick', `selectObject(${obj.id})`);
                
                button.innerHTML = `
                    <img src="${obj.clean}" 
                         onerror="this.onerror=null; this.src='https://placehold.co/120x120/000000/FFFFFF?text=${obj.name}'" 
                         alt="${obj.name}" 
                         class="btn-image">
                    <span class="mt-4 text-sm text-white tracking-widest uppercase font-semibold">${obj.name}</span>
                `;
                selectionContainer.appendChild(button);
            });
            
            // Reset State
            currentZoom = 1.0;
            panX = 0;
            panY = 0;
            maxZoomReached = false;
            updateZoomPrompt();
            
            if (typingInterval) clearInterval(typingInterval);
            
            setActiveScreen('selection-screen');
        }

        function selectObject(id) {
            selectedObjectId = id;
            const data = OBJECT_DATA.find(o => o.id === id);
            
            // Setup Layers
            document.getElementById('layer-clean').src = data.clean;
            if (decay1Layer) decay1Layer.src = data.decay1;
            if (decay2Layer) decay2Layer.src = data.decay2;
            if (catastropheLayer) catastropheLayer.src = data.catastrophe;
            
            document.getElementById('object-name-display').textContent = data.name.toUpperCase();

            // Video Setup & MASKING
            if (videoLayer) {
                const sourceElement = document.createElement('source');
                sourceElement.src = data.video;
                sourceElement.type = 'video/mp4';
                videoLayer.innerHTML = ''; 
                videoLayer.appendChild(sourceElement);
                videoLayer.load();
                videoLayer.play().catch(e => {}); 
                videoLayer.style.opacity = 0;
                
                // Apply mask (This ensures video ONLY shows on the object)
                const maskUrl = `url('${data.clean}')`;
                videoLayer.style.webkitMaskImage = maskUrl;
                videoLayer.style.maskImage = maskUrl;
                videoLayer.style.mixBlendMode = 'overlay';
            }

            // Reset View
            currentZoom = 1.0;
            panX = 0;
            panY = 0;
            maxZoomReached = false;
            updateVisuals();
            updateZoomPrompt();
            
            setActiveScreen('interactive-screen');
        }

        // --- Logic: Pan & Zoom ---
        
        function updateVisuals() {
            if (zoomContainer) {
                zoomContainer.style.transform = `translate(-50%, -50%) translate(${panX}px, ${panY}px) scale(${currentZoom})`;
            }
            document.getElementById('zoom-level').textContent = currentZoom.toFixed(1);
            updateLayerOpacities();
        }

        function handleWheel(event) {
            event.preventDefault();
            const delta = event.deltaY * -0.01; 
            
            let newZoom = currentZoom + delta;
            newZoom = Math.max(1.0, Math.min(MAX_ZOOM, newZoom));
            
            currentZoom = newZoom;
            
            // If zooming out to 1.0, center the object
            if (currentZoom <= 1.0) {
                panX = 0;
                panY = 0;
            } else {
                // Constraint: Keep image inside view
                const maxPan = (800 * (currentZoom - 1)) / 2; 
                panX = Math.max(-maxPan, Math.min(maxPan, panX));
                panY = Math.max(-maxPan, Math.min(maxPan, panY));
            }

            updateVisuals();
            handleZoomEndLogic();
        }

        function handleMouseDown(event) {
            if (currentZoom > 1.0) {
                isDragging = true;
                lastMouseX = event.clientX;
                lastMouseY = event.clientY;
                document.body.style.cursor = 'grabbing';
            }
        }

        function handleMouseMove(event) {
            if (!isDragging) return;
            event.preventDefault();

            const currentX = event.clientX;
            const currentY = event.clientY;
            
            const deltaX = currentX - lastMouseX;
            const deltaY = currentY - lastMouseY;
            
            // 1:1 Pan Logic
            panX += deltaX / currentZoom;
            panY += deltaY / currentZoom;

            lastMouseX = currentX;
            lastMouseY = currentY;
            
            updateVisuals();
        }

        function handleTouchStart(event) {
            if (event.touches.length === 1 && currentZoom > 1.0) {
                isDragging = true;
                lastMouseX = event.touches[0].clientX;
                lastMouseY = event.touches[0].clientY;
            }
        }
        
        function handleTouchMove(event) {
            if (!isDragging) return;
            event.preventDefault();
            const touch = event.touches[0];
            
            const deltaX = touch.clientX - lastMouseX;
            const deltaY = touch.clientY - lastMouseY;
            
            panX += deltaX / currentZoom;
            panY += deltaY / currentZoom;
            
            lastMouseX = touch.clientX;
            lastMouseY = touch.clientY;
            
            updateVisuals();
        }

        function handleMouseUp() {
            isDragging = false;
            document.body.style.cursor = 'grab';
        }

        // --- Transition Logic ---
        function getLayerProgress(minZoom, maxZoom) {
            if (currentZoom < minZoom) return 0;
            if (currentZoom >= maxZoom) return 1;
            return (currentZoom - minZoom) / (maxZoom - minZoom);
        }

        function updateLayerOpacities() {
            // Post-Max Zoom State: Exit behavior (Low opacity video, Full catastrophe)
            if (maxZoomReached) {
                if (catastropheLayer) catastropheLayer.style.opacity = 1.0;
                
                // Video remains at low opacity (0.3) for exit effect
                if (videoLayer) videoLayer.style.opacity = 0.3;
                
                // Other layers fade out normally (doesn't really matter as catastrophe is 1.0)
                if (decay1Layer) decay1Layer.style.opacity = Math.min(1.0, getLayerProgress(1.0, 5.0));
                if (decay2Layer) decay2Layer.style.opacity = Math.min(1.0, getLayerProgress(5.0, 10.0));
                return; 
            }
            
            // Normal Zoom In Logic
            if (decay1Layer) decay1Layer.style.opacity = getLayerProgress(1.0, 5.0);
            if (decay2Layer) decay2Layer.style.opacity = getLayerProgress(5.0, 10.0);
            if (catastropheLayer) catastropheLayer.style.opacity = getLayerProgress(10.0, 20.0);

            // Video fades in strongly (up to 0.9) as we approach max zoom
            if (videoLayer) {
                const videoProgress = getLayerProgress(5.0, MAX_ZOOM);
                videoLayer.style.opacity = videoProgress * 0.9; 
            }
        }

        function handleZoomEndLogic() {
            // Check if we reached max zoom
            if (currentZoom >= MAX_ZOOM) {
                maxZoomReached = true;
                updateZoomPrompt();
                // Make catastrophe visible immediately
                if (catastropheLayer) catastropheLayer.style.opacity = 1.0;
            } 
            
            // Check if we are back at 1.05 (tolerance) AND max was reached previously
            if (maxZoomReached && currentZoom <= 1.05) {
                updateZoomPrompt(); // Show double click message
                document.body.style.cursor = 'pointer'; 
            } else {
                document.body.style.cursor = isDragging ? 'grabbing' : 'grab';
                if (!maxZoomReached) updateZoomPrompt(); 
            }
        }
        
        function updateZoomPrompt() {
            const scrollPrompt = document.getElementById('zoom-prompt');
            const clickPrompt = document.getElementById('double-click-prompt');
            
            if (maxZoomReached && currentZoom <= 1.05) {
                // Cycle complete state
                scrollPrompt.style.opacity = '0';
                clickPrompt.style.opacity = '1';
            } else {
                // Normal state
                scrollPrompt.style.opacity = '1';
                clickPrompt.style.opacity = '0';
            }
        }

        // --- Data Screen ---
        function updateDataScreen(id) {
            const data = OBJECT_DATA.find(o => o.id === id);
            
            if (videoLayer) {
                videoLayer.pause();
                videoLayer.currentTime = 0;
            }

            document.getElementById('data-title').textContent = `${data.name.toUpperCase()} | ANALYSIS COMPLETE`;
            document.getElementById('data-id-display').textContent = String(id).padStart(2, '0');
            
            setupDataStageSelectors(data);
            
            // Start with catastrophe log
            const logText = data.logs['catastrophe'];
            typeWriter(logText, 'data-log');
            
            setActiveScreen('data-screen');
        }

        function setupDataStageSelectors(data) {
            const listContainer = document.getElementById('stage-selection-list');
            listContainer.innerHTML = '';
            
            const stages = [
                { key: 'clean', name: 'CLEAN', file: data.clean },
                { key: 'decay1', name: 'DECAY I', file: data.decay1 },
                { key: 'decay2', name: 'DECAY II', file: data.decay2 },
                { key: 'catastrophe', name: 'CATASTROPHE', file: data.catastrophe }
            ];

            stages.forEach(stage => {
                const button = document.createElement('div');
                const isActive = stage.key === 'catastrophe' ? 'active' : ''; 
                button.className = `stage-selector ${isActive}`;
                button.setAttribute('onclick', `selectDataStage('${stage.key}', '${stage.name}', '${stage.file}')`);
                
                button.innerHTML = `
                    <img src="${stage.file}" 
                         onerror="this.onerror=null; this.src='https://placehold.co/120x120/000000/FFFFFF?text=${stage.name}'" 
                         alt="${stage.name}">
                `;
                listContainer.appendChild(button);
            });
            
            selectDataStage('catastrophe', 'CATASTROPHE (FINAL STATE)', data.catastrophe);
        }

        function selectDataStage(key, name, file) {
            const mainImage = document.getElementById('data-stage-image');
            mainImage.src = file;
            mainImage.onerror = function() {
                this.onerror = null; 
                this.src = `https://placehold.co/400x400/000000/FFFFFF?text=${name}`;
            }
            
            document.getElementById('log-stage-name').textContent = name;

            document.querySelectorAll('.stage-selector').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.stage-selector[onclick*='${key}']`).classList.add('active');
            
            const data = OBJECT_DATA.find(o => o.id === selectedObjectId);
            if (data && data.logs && data.logs[key]) {
                typeWriter(data.logs[key], 'data-log');
            }
        }

        function handleDoubleClick() {
            // Strict condition: Only if max reached AND back at start (tolerance added)
            if (selectedObjectId !== null && maxZoomReached && currentZoom <= 1.05) {
                updateDataScreen(selectedObjectId);
            }
        }

        function returnToSelection() {
            initSelectionScreen();
        }

        // --- Init ---
        window.onload = function() {
            decay1Layer = document.getElementById('layer-decay1'); 
            decay2Layer = document.getElementById('layer-decay2'); 
            catastropheLayer = document.getElementById('layer-catastrophe'); 
            videoLayer = document.getElementById('layer-video'); 
            zoomContainer = document.getElementById('object-container');
            
            initSelectionScreen();
        };
    </script>
</body>
</html>